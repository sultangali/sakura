# Обновление сервера - конвертация WMF в PNG

## Что изменено

1. Добавлены зависимости `sharp` и `jimp` для обработки изображений
2. Все изображения теперь конвертируются в PNG (включая WMF/EMF)
3. Изображения автоматически:
   - Обрезаются (пустые края удаляются)
   - Уменьшаются если больше 600px по ширине
   - Оптимизируются для уменьшения размера файла

## Обновление на сервере

### Шаг 1: Обновите код

```bash
cd /var/www/platonus/server

# Если используете git
git pull

# Или скопируйте обновленные файлы:
# - server/index.js
# - server/package.json
```

### Шаг 2: Установите новые зависимости

```bash
cd /var/www/platonus/server
npm install
```

Это установит:
- `sharp` - для обработки изображений (конвертация, обрезка, изменение размера)
- `jimp` - для создания placeholder изображений

### Шаг 3: Перезапустите сервер

```bash
pm2 restart platonus-server
```

### Шаг 4: Проверьте логи

```bash
pm2 logs platonus-server --lines 30
```

Должно показать:
```
✓ Sharp загружен для обработки изображений
✓ Jimp загружен для обработки изображений
```

## Проверка работы

1. Загрузите новый DOCX файл с вопросами
2. Проверьте, что изображения сохраняются как `.png`
3. Откройте изображение в браузере - должно отображаться без проблем

## Что происходит с изображениями

### Обычные изображения (PNG, JPG):
- Конвертируются в PNG
- Обрезаются пустые края
- Уменьшаются если > 600px по ширине
- Оптимизируются для уменьшения размера

### WMF/EMF изображения (формулы из Word):
- Конвертируются в PNG-placeholder с текстом "[Формула/изображение]"
- Это временное решение, так как WMF/EMF требуют специальные программы для конвертации

### Если sharp не установлен:
- Изображения сохраняются в оригинальном формате
- Сервер продолжает работать без ошибок

## Troubleshooting

### Ошибка: "sharp: Installation error"

```bash
# Пересоберите sharp
cd /var/www/platonus/server
npm rebuild sharp
```

### Ошибка: "Cannot find module 'sharp'"

```bash
cd /var/www/platonus/server
rm -rf node_modules
npm install
```

### Изображения все еще в формате WMF

1. Проверьте, что `sharp` установлен: `npm list sharp`
2. Проверьте логи сервера: `pm2 logs platonus-server`
3. Перезапустите сервер: `pm2 restart platonus-server`

## Локальная разработка

```bash
cd server
npm install  # Установит sharp и jimp
npm run dev
```



